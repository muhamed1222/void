# Архитектура разработки — «Белая комната» (Cursor AI, v0.4.1)

> Цель: практичный план под Cursor AI — стек, структура, зависимости, правила таймера/хранилища, ИИ‑интеграция, тесты, релизы, безопасность и точки миграции.

---

## 0) Принципы

* **Стерильность интерфейса** → текст, таблицы, консольные блоки. Минимум анимаций/цвета.
* **Оффлайн‑первая** → всё важное хранится локально; сеть — для ИИ.
* **Простые числа** → индексы/дельты вместо «геймификации».
* **Без экспорта** (по продукту); но есть «стереть журнал/конфигурацию».
* **Переход из managed Expo в bare RN** спроектирован заранее.

---

## 1) Стек

**Клиент:** Expo (React Native + TypeScript, Hermes)

* Навигация: **`@react-navigation/native` (Stack + BottomTabs) + Deep Links** (`wr://`)
* Состояние: `zustand` + `persist` (на **MMKV**)
* Хранилище:

  * Лёгкие состояния/флаги → **MMKV** (`react-native-mmkv`)
  * Журналы/протоколы/сессии → **SQLite** (`expo-sqlite`) с миграциями
* Списки: `@shopify/flash-list` (виртуализация логов/реестров)
* Нотификации (M1): `expo-notifications`
* Тесты: Jest + React Native Testing Library; E2E: Detox (ключевые сценарии)
* Аналитика/краши: локальный лог + Sentry (прицельно, с фильтрами PII)
* Схемы/валидация: `zod` (строгая проверка входов ИИ‑функций)

**ИИ‑слой:** провайдер‑агностичный HTTP (OpenAI‑совместимый/другой)

* Ядро наставника + **function‑calling** к «инструментам» приложения
* Идемпотентность команд — `nonce`
* Маски тона: `neutral` / `support` / `ultra`
* **Надёжность:** ретраи (экспонента), таймауты, rate‑limit, оффлайн‑fallback (заготовки)

**CI/CD:**

* GitHub Actions: typecheck + lint + test + (опц.) build‑simulators
* EAS Build/Submit (iOS/Android)
* EAS Update: каналы `dev/beta/prod`, **canary rollout** 10%→50%→100%, кнопка rollback

**Локализация:** ru → en (позже)

---

## 2) Структура репозитория

```
apps/mobile/                 # при одиночном приложении можно корень проекта без apps/
  app.json / app.config.ts
  package.json / tsconfig.json / babel.config.js
  src/
    navigation/             # stacks, tabs, linking (react-navigation)
    screens/
      Today/
      Diagnostics/
      Console/
      Entry/
      Record/
      Catalog/
      Settings/
      Archive/
      Scenarios/
      Status/
      Docs/
    components/
      lists/ forms/ console/
    store/
      useStore.ts          # zustand + persist (MMKV)
      slices/
    services/
      coachAgent/          # ИИ‑наставник (адаптеры провайдеров)
      scheduler/
      metrics/
      bestWindow/
      storage/             # MMKV / SQLite wrapper + миграции
      notifications/
    domain/
      types.ts constants.ts flags.ts
    utils/
      time.ts id.ts fmt.ts
    theming/
      typography.ts spacing.ts
  e2e/                      # detox
  .env .env.production
  README.md
```

> Зафиксировано: **react-navigation**. `expo-router` не используем.

---

## 3) Данные и модели (сводно)

```ts
export type Mood = -2|-1|0|1|2;
export type Domain = 'mind'|'body'|'social';

export interface UserProfile {
  id: string; goals: string[]; wakeTime?: string; coachMode: 'soft'|'strict';
}

export interface PlanBlock {
  id: string; start: string; end: string;
  kind: 'focus'|'mind'|'body'|'social'|'break'|'ritual';
  required?: boolean; exerciseId?: string;
}
export interface DayPlan { date: string; blocks: PlanBlock[]; requiredMin: number; status: 'new'|'in_progress'|'done'; }

export interface Session {
  id: string; type: 'focus'|Domain; startedAt: string; endedAt?: string; completed: boolean;
  interruptions?: { t: string; note: string }[];
}

export interface JournalEntry { date: string; obstacles: string[]; mood: Mood; notes?: string; }

export interface Stats { streak: number; mind: number; body: number; social: number; discipline: number; }
export interface StateVector extends Stats { sleepQuality?: number; mood?: Mood; failures7d: number; }

export interface Protocol { id: string; title: string; durationMin: number; level: 1|2|3; domain: Domain; steps?: string[]; }
export interface Scenario { id: string; title: string; steps: string[]; durationMin: number; }
```

**SQLite:**

* `sessions(id, type, startedAt, endedAt, completed, interruptions_json)`
* `journal(date PRIMARY KEY, obstacles_json, mood, notes)`
* `plans(date PRIMARY KEY, json)`
* `stats(date PRIMARY KEY, streak, mind, body, social, discipline)`
* `protocols(id PRIMARY KEY, title, domain, durationMin, level, steps_json)`

---

## 4) Версионирование стора и БД

* **MMKV STATE\_VERSION**: хранить версию стора; при несовместимости → миграция или жёсткая очистка с подтверждением
* **SQLite миграции:** `migrations/{001.sql, 002.sql}`; каждая — в транзакции; таблица `schema_version(version INT)`
* При сбое миграции — откат транзакции, запись ошибки в локальный лог

---

## 5) Состояние и хранение

* **Zustand + persist (MMKV)** — быстрые UI‑состояния (план на сегодня, сообщения Консоли, флаги)
* **SQLite** — долговременные записи и логи (append‑only → агрегировать в Stats)
* Ничего «тяжёлого» в AsyncStorage

---

## 6) Таймер и фон (устойчивость)

* Сессия хранит `intervals: Array<{start:number; end?:number}>` и `startedAt`
* Остаток считается из суммарной длительности интервалов; при паузе добавляется `end`
* Подписка на `AppState`; на `active` пересчёт и синхронизация
* Детект системного сдвига времени/DST: `abs(Δtime)>5 мин` → пометить сессию как *suspect* и запросить подтверждение
* Kill‑by‑OS: при холодном старте — восстановление по последнему интервалу; если «завис» без `end`, закрыть его текущим временем
* Критерий миграции в **bare RN**: фоновые задачи >10 мин / Always‑On / HealthKit → вынос таймера в native (Headless JS/BGTasks)

---

## 7) Формулы метрик

```
SR          = обязательные_выполненные / обязательные_всего      // 0..1
FOCUS_NORM  = clamp(минуты_фокуса/60, 0, 1)
TTS_NORM    = clamp(медиана_TTS/60с, 0, 1)
Discipline  = clamp(round((0.5*SR + 0.3*FOCUS_NORM + 0.2*(1-TTS_NORM))*100), 0, 100)
```

* EMA(α=0.2) по фокусу/срывам; длительность блока ограничивать **\[10, 30] мин**
* BestWindow: SR по окнам «утро/день/вечер»; тяжёлые задачи → окно с max SR

---

## 8) ИИ‑наставник (архитектура)

**Инструменты (function‑calling):**

```ts
export const tools = {
  readDayState: {},           // -> StateVector
  readJournal: {},            // (days:number) -> JournalEntry[]
  writePlan: {},              // (plan:DayPlan) -> { ok, nonce }
  startFocusTimer: {},        // (minutes:number, nonce:string) -> { startedAt }
  adjustLoad: {},             // (level:'down'|'up'|'stable', reason?:string)
  suggestRitual: {},          // (trigger:'start'|'midday'|'evening') -> {title,steps[]}
  safetyCheck: {},            // (symptoms:string[]) -> { allowed, altPlan? }
} as const;
```

**Системный промпт:** коротко (≤3 пункта), 1 «узел» проблемы, план на 20–120 мин, учитывать bestWindow/сигналы, завершать «Ответь ОК». При рисках — `safetyCheck` и упрощение.

**Надёжность ИИ:**

* Таймаут 12с; ретраи: `500ms * 2^n`, max 3
* Rate‑limit: ≥5с между вызовами; очередь запросов
* Оффлайн: локальные заготовки подсказок (минимум/снижение/рефлексия)
* Лог: `promptId, toolsUsed, duration, resultCode` (без PII)
* `zod.safeParse` результатов tool‑вызовов → **fail fast**

---

## 9) Экранные контуры (Definition of Done)

**Сегодня:** инструкция (контекстная) → 3–5 задач (включая книгу) → мини‑отчёт → сниппет Консоли

* DoD: TTS замерен; «Снизить нагрузку» меняет план; книга — как задача

**Диагностика:** метрики + дельты; бар «7 дней минимум (✓/✗)»; лог; вывод наставника

* DoD: дельты «сегодня vs вчера»; сворачивание лога; 1 рекомендация

**Консоль:** протокол/команды; спец‑вставки (план‑2ч)

* DoD: `/minimum`, `/plan`, `/lower`, `/reflect` работают; «план» — блочным форматированием

**Запись №…:** заголовок «Запись №xxx (YYYY‑MM‑DD)»; чипы/иконки; ✓/✗ задач; вывод

* DoD: запись сохраняется; история 7; вывод обновляется

**Каталог протоколов:** таблица №/название/длительность/lvl; `> start <id>`

* DoD: протокол стартует; таймер от `startedAt`

**Параметры системы:** ID/цели; режим; график; сигналы; «стереть журнал/конфигурацию»

* DoD: хранится в MMKV; действия необратимы с подтверждением

**Протоколы (архив):** реестр «№ дата индикатор 2/3»; фильтры `/all /mind /body /social /focus`; `> find`

* DoD: быстрый поиск по номеру/типу; переход в запись

**Сценарии:** №/название/мин; экран сценария с шагами; `> start 01`

* DoD: сценарий запускается; шаги отображаются

**Состояние системы:** индексы; недельные дельты; стратегический вывод

* DoD: дельты по 7 дням; вывод меняется раз в день

**Протокол №00:** статический документ с правилами/индексами

* DoD: доступен из настроек/первого входа

**Экран допуска:** выдача User#ID и вход

* DoD: ID кэшируется (MMKV); повторный запуск пропускает экран

---

## 10) Навигация и Deep Links

* Root Tabs: **Сегодня • Диагностика • Консоль**
* Stack: Запись №… / Каталог / Сценарии / Протоколы / Параметры / Состояние системы / Протокол №00 / Экран допуска
* **Deep Links (schema `wr://`)**: `wr://record/:id`, `wr://protocol/:id`, `wr://console`

---

## 11) Конфигурация и секреты

* `app.config.ts` → `extra: { apiBaseUrl, aiKeyName, buildChannel, linkSchema:'wr' }`
* `.env*` подхватываются в конфиге; ключи ИИ в код не жёстко
* При появлении бекенда — TLS обязателен; план: certificate pinning (ATS/iOS, networkSecurityConfig/Android)

---

## 12) Политика данных и безопасность

* Все журналы локальны; **удаление необратимо** (стереть журнал/конфигурацию)
* Протокол №00 описывает, какие данные хранятся и зачем (право на информацию)
* Сетевой обмен с ИИ — без пользовательских заметок/журналов (PII фильтруется)
* **Safety‑гейт**: триггеры — «боль», «паника», «самоповреждение», «суицид» → мгновенная деэскалация плана + нейтральный отказ; контакт экстренной помощи (локально зашитые строки)

---

## 13) Качество кода и перфоманс‑бюджеты

* TypeScript `strict: true`; ESLint (airbnb‑base + react‑native), Prettier
* Husky + lint‑staged: typecheck/lint/test до коммита
* UI‑перф чек‑лист: FlashList + `getItemType`, `keyExtractor`, `memo`; запрет анонимных коллбеков в JSX
* Бюджеты: **bundle JS ≤ 2.0 MB gzip**, **cold start ≤ 2.5s (Pixel 4a)**, **crash‑free ≥ 99%**

---

## 14) Доступность (минимум)

* Все интерактивы с `accessibilityRole`/`accessibilityLabel`
* Контраст ≥ 7:1 (ч/б соответствует)
* VoiceOver/TalkBack на ключевых экранах (Сегодня, Консоль, Запись)

---

## 15) Спецификация команд Консоли

```
/minimum [15|20]       — старт минимума
/plan [60|120]         — план на N минут (дефолт 120)
/lower                 — снизить нагрузку на сегодня
/reflect               — открыть «Запись №…»
/start <protocolId>    — запустить протокол каталога
```

* Ответы — блочным форматированием; ошибки — сухо, с кодом и подсказкой

---

## 16) Пайплайн с Cursor AI

**Подготовка контекста:** `docs/` (это ТЗ), `CURSOR_RULES.md` (тон UI, архитектурные ограничения, формат команд)

**Шаблоны задач (копируй в Cursor):**

1. *Screen Scaffold* — экран Today
2. *Timer Core* — таймер от `intervals` + `startedAt`
3. *Coach Tools* — tools + zod + nonce
4. *Storage* — MMKV + SQLite + миграции
5. *Archive & Find* — «Протоколы» + поиск

**Практика:** короткие PR, автотесты в диффе, профилировать списки, никаких скрытых зависимостей/цветов

---

## 17) Тестирование

* **Unit:** scheduler/bestWindow/EMA/format
* **Component (RTL):** Today, Console, Record, Catalog
* **E2E (Detox):** старт минимума → завершение; «Запись №…»; `/plan` в Консоли

---

## 18) Релизы

* Каналы EAS Update: `dev` / `beta` / `prod` (canary → full)
* OTA меняет только JS; натив — новый билд
* Версионирование: `app.json` + `buildNumber`/`versionCode`; **rollback** в EAS Update включён

---

## 19) Дорожная карта (Dev)

* S0: Entry, Today, Console (минимум), Timer, Store (MMKV), Journal (SQLite)
* S1: Diagnostics, Record, Archive, Catalog, Scenarios
* S2: Status, Settings, Docs (№00)
* S3: ИИ‑интеграция (реальный провайдер), нотификации, A/B флаги

---

## 20) Гайды по стилю (UI)

* Шрифты: системный San‑Serif; моноширинный — для консоли/номеров
* Цвета: #000 / #111 / #666 / #AAA / #FFF; линии 1px
* Эффекты: никаких теней/скруглений; только разделители/отступы

---

Документ обновлён: зафиксирован роутер, добавлены версии стора/БД и миграции, устойчивый таймер, формулы метрик, надёжность ИИ, политика данных и safety‑гейт, перф‑бюджеты, доступность, команды консоли, Deep Links и CI/CD с canary/rollback.
# Архитектура разработки — White Room (Mobile)

Цели: оффлайн‑первая, минимализм в UI/UX, прозрачные данные, надёжность синка, провайдер‑агностичный ИИ‑слой.

## Принципы

- Оффлайн‑первая: все ключевые действия доступны без сети, фоновые синки очередями.
- Простота слоёв: экраны → компоненты → store → сервисы → storage/network → domain.
- Явные типы: все доменные сущности и контракты описаны в `src/domain`.
- Надёжность: ретраи с экспонентой, таймауты, идемпотентность (nonce), локальные логи.
- Безопасность: локальные данные, PII не уходит в ИИ, safety‑гейт на критические действия.

## Технологический стек

- Expo (React Native + TypeScript)
- Навигация: `@react-navigation/*` (Stack + Tabs)
- Состояние: `zustand` + `persist` (MMKV)
- Хранилища: MMKV (легковесные), SQLite (журналы/сессии/планы/статы)
- Списки: `@shopify/flash-list`
- Тесты: Jest + RNTL, Detox (E2E)
- ИИ: HTTP, провайдер‑агностичный, совместимый с OpenAI API

## Структура проекта (mobile)

```
src/
  navigation/      # маршруты и контейнеры навигации
  screens/         # экраны (Today, Console, etc.)
  components/      # переиспользуемые UI‑компоненты
  store/           # zustand store
  services/        # network, storage, coachAgent, миграции, и т.д.
  domain/          # типы, константы, флаги
  theming/         # типографика, spacing, палитра
  utils/           # утилиты (время/формат/валид/…)
e2e/             # Detox
```

## Данные и модели

- Типы: `src/domain/types.ts` (Session, JournalEntry, DayPlan, Protocol, Stats, StateVector, TaskItem, Message …)
- Константы/флаги: `src/domain/constants.ts`, `src/domain/flags.ts`
- Версионирование: `STATE_VERSION`, `DB_VERSION` для миграций стора и БД

## Хранилище

- MMKV: быстрые ключи и persisted store
- SQLite: таблицы `sessions`, `journal`, `plans`, `stats`, `protocols`, `schema_version`
- Миграции: `services/storage` (DB) и `services/migrations` (state)

## Сервисы

- NetworkService: читает `extra.apiBaseUrl` из `app.json`, таймаут, ретраи (экспонента)
- Storage: MMKV helpers, SQLite init, CRUD
- CoachAgent: системный prompt, ретраи, offline‑fallback, инструменты (tool‑calling) через интерфейс
- Safety: проверка рисков перед тяжёлыми/стрессовыми сценариями

## Today v0.3 (ключевые требования)

- Блоки: ContextualInstruction → TaskList (3–4) + ProgressBar → MiniReport → CoachChat (сниппет)
- Типы: `TaskItem`, `Message`; store: `contextualInstruction`, `todayTasks`, `streak`, `disciplineScore`, `focusTime`, `coachMessages`
- Списки: FlashList (при тестах можно подменять на FlatList)
- Мини‑отчёт: streak, discipline, focusTime (моно‑шрифт, компактно)

## ИИ и интеграции

- AI endpoint: `extra.apiBaseUrl`, POST, 12s таймаут, 3 ретрая, идемпотентность (nonce)
- Task completion: локальный апдейт (MMKV/SQLite) + очередь синка (rate limit ≥5s)

## Безопасность

- Данные локально; запреты на PII в запросах к ИИ
- Safety‑гейт на повышающие нагрузку действия

## Тестирование

- Unit: jest + RNTL
- E2E: Detox
- Стаб‑моки темизации и FlashList в тестах

## Перфоманс

- Бюджет: быстрые списки (FlashList), мемоизация, лёгкий рендер
- Логи производительности (позже) и профилирование ключевых путей
